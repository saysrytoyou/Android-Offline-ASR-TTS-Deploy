# ğŸ¤– Android ç¦»çº¿æµå¼è¯­éŸ³åŠ©æ‰‹ (ASR & TTS)

è¿™æ˜¯ä¸€ä¸ªåŸºäº [Sherpa-onnx](https://github.com/k2-fsa/sherpa-onnx) æ¨ç†æ¡†æ¶æ·±åº¦ä¼˜åŒ–çš„ **Android ç«¯ä¾§å®Œå…¨ç¦»çº¿è¯­éŸ³ç»„ä»¶**ã€‚æœ¬é¡¹ç›®ä¸ä»…å®ç°äº†è¯­éŸ³è¯†åˆ«ä¸åˆæˆåŠŸèƒ½ï¼Œè¿˜é’ˆå¯¹â€œç«¯ä¾§ç®—åŠ›ç“¶é¢ˆâ€å’Œâ€œæ¨¡å‹å¹»è§‰â€è¿›è¡Œäº†å•†ä¸šçº§çš„åº•å±‚æ¶æ„é‡æ„ï¼Œå®ç°äº†**æ— ç¼è¿è¯»ã€é¦–å­—ç§’å‡ºã€è¾¹è¯´è¾¹è¯†åˆ«**çš„æè‡´ä½“éªŒã€‚

## âœ¨ æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹

### ğŸ™ï¸ 1. é«˜ç²¾åº¦æµå¼è¯†åˆ« (Paraformer ASR)

* **è¾¹è¯´è¾¹å‡ºå­—**ï¼šé‡‡ç”¨éè‡ªå›å½’çš„ Paraformer æµå¼åŒè¯­æ¶æ„ï¼Œå®ç°é›¶å»¶è¿Ÿçš„å®æ—¶è¯­éŸ³è½¬å†™ã€‚
* **å…ç–«â€œå¤è¯»æœºâ€å¹»è§‰**ï¼šå½»åº•è§£å†³ä¼ ç»Ÿ Transducer æ¨¡å‹åœ¨ç¯å¢ƒåº•å™ªæˆ–é™éŸ³æ—¶ç–¯ç‹‚è¾“å‡ºé‡å¤å­—ï¼ˆå¦‚â€œå–‚å–‚å–‚å–‚â€ï¼‰çš„ç—›ç‚¹ã€‚
* **åŠ¨æ€ç«¯ç‚¹æ£€æµ‹ (VAD)**ï¼šç²¾å‡†åˆ¤æ–­ç”¨æˆ·è¯´è¯åœé¡¿ï¼Œè‡ªåŠ¨æ–­å¥å¹¶æˆªæ–­éŸ³é¢‘æµã€‚

### ğŸ—£ï¸ 2. æè‡´æ— ç¼æ’­æŠ¥ (Streaming TTS)

* **å¤šæ ¸å¹¶è¡ŒåŠ é€Ÿ**ï¼šå¼ºè¡Œè§£é” 4 æ ¸ CPU çº¿ç¨‹ (`numThreads = 4`) è¿›è¡Œåº•å±‚å¼ é‡è®¡ç®—ï¼Œç”Ÿæˆé€Ÿåº¦æå‡ 300% ä»¥ä¸Šã€‚
* **åŒçº¿ç¨‹æµæ°´çº¿ (Producer-Consumer)**ï¼šå¼•å…¥ `LinkedBlockingQueue` ç¼“å†²é˜Ÿåˆ—ã€‚åå°æ‹¼å‘½ç”ŸæˆéŸ³é¢‘ï¼Œå‰å°æŒ‰åºæ— ç¼æ’­æ”¾ï¼Œå½»åº•æ¶ˆé™¤é•¿æ–‡åˆæˆæ—¶çš„ CPU ç­‰å¾…å¡é¡¿ã€‚
* **åŠ¨æ€ VAD é™éŸ³åˆ‡é™¤**ï¼šé’ˆå¯¹ VITS æ¨¡å‹è‡ªå¸¦çš„â€œå¥é¦–å¥å°¾ 0.2 ç§’å¼ºåˆ¶é™éŸ³â€ï¼Œåœ¨æ¨å…¥æ’­æ”¾ç®¡é“å‰é‡‡ç”¨å£°å­¦èƒ½é‡è®¡ç®—ï¼ŒåŠ¨æ€ç æ‰æ— å£°æ³¢å½¢ï¼Œå®ç°å¦‚åŒçœŸäººå‘¼å¸èˆ¬è‡ªç„¶çš„è¿è¯»èŠ‚å¥ã€‚
* **æ™ºèƒ½é•¿å¥é™çº§åˆ‡åˆ†**ï¼šé‡åˆ°è¶…é•¿å¤æ‚å¥ï¼Œå¼•æ“ä¼šè‡ªåŠ¨åœ¨é€—å·å¤„é™çº§åˆ‡åˆ†ï¼Œç¡®ä¿ä½ç«¯æœºå‹ä¸Šä¹Ÿèƒ½åšåˆ°**é¦–å­—å“åº”æ—¶é—´ < 0.5 ç§’**ã€‚

### âœ¨ 3. æ™ºèƒ½æ’ç‰ˆæµæ°´çº¿

* å†…ç½® 300MB çº§åˆ«çš„ **CT-Transformer** æ ‡ç‚¹å¤§æ¨¡å‹ã€‚
* ç”¨æˆ·è¯´å®Œæ¾å¼€æŒ‰é’®çš„ç¬é—´ï¼Œæ¯«ç§’çº§ä¸ºâ€œè£¸æ–‡æœ¬â€æ·»åŠ ç²¾å‡†çš„é€—å·ã€å¥å·ã€é—®å·ï¼Œå¹¶ä¿®å¤è‹±æ–‡çš„å¤§å°å†™æ ¼å¼ã€‚

---

## ğŸ“¥ æ ¸å¿ƒæ¨¡å‹ä¸‹è½½ (å¿…è¯»)

ç”±äº GitHub æ–‡ä»¶å¤§å°é™åˆ¶ï¼Œæœ¬é¡¹ç›®ä»“åº“**ä¸åŒ…å«**å¤§å‹ `.onnx` æ¨¡å‹æ–‡ä»¶ã€‚è¯·æ‰‹åŠ¨ä¸‹è½½ä»¥ä¸‹æ–‡ä»¶å¹¶ä¸¥æ ¼æŒ‰ç…§ç›®å½•ç»“æ„æ”¾å…¥ `app/src/main/assets/` ç›®å½•ä¸‹ã€‚

| ç»„ä»¶ | æ¨¡å‹æ¶æ„ | ä¸‹è½½é“¾æ¥ (å›½å†…ç›´è¿) | è¯´æ˜ |
| --- | --- | --- | --- |
| **ASR** | Paraformer åŒè¯­æµå¼ | **[encoder](https://www.google.com/search?q=https://hf-mirror.com/csukuangfj/sherpa-onnx-streaming-paraformer-bilingual-zh-en/resolve/main/encoder.int8.onnx)** <br>

<br> **[decoder](https://www.google.com/search?q=https://hf-mirror.com/csukuangfj/sherpa-onnx-streaming-paraformer-bilingual-zh-en/resolve/main/decoder.int8.onnx)** <br>

<br> **[tokens](https://www.google.com/search?q=https://hf-mirror.com/csukuangfj/sherpa-onnx-streaming-paraformer-bilingual-zh-en/resolve/main/tokens.txt)** | å¿…é¡»å…¨éƒ¨ä¸‹è½½å¹¶æ”¾å…¥ `asr` æ–‡ä»¶å¤¹ä¸­ã€‚ |
| **TTS** | MeloTTS (VITS) | **[ç‚¹å‡»ä¸‹è½½å‹ç¼©åŒ…](https://www.google.com/search?q=https://mirror.ghproxy.com/https://github.com/k2-fsa/sherpa-onnx/releases/download/tts-models/vits-melo-tts-zh_en.tar.bz2)** | **æåº¦é‡è¦**ï¼šè§£å‹åï¼Œè¯·å°†å†…éƒ¨çš„ `dict` æ–‡ä»¶å¤¹é‡Œçš„æ‰€æœ‰å­—å…¸æ–‡ä»¶**å…¨éƒ¨ç§»å‡º**ï¼Œä¸æ¨¡å‹å¹³çº§å­˜æ”¾ï¼ |
| **Punct** | CT-Transformer | **[ç‚¹å‡»ä¸‹è½½å‹ç¼©åŒ…](https://www.google.com/search?q=https://mirror.ghproxy.com/https://github.com/k2-fsa/sherpa-onnx/releases/download/punctuation-models/sherpa-onnx-punct-ct-transformer-zh-en-vocab272727-2024-04-12.tar.bz2)** | æä¾›æ™ºèƒ½æ ‡ç‚¹ä¸å¤§å°å†™æ¢å¤ã€‚ |

---

## ğŸ“‚ èµ„æºç›®å½•ç»“æ„ (Assets)

é…ç½®å®Œæˆåï¼Œæ‚¨çš„ `assets` ç›®å½•å¿…é¡»ä¸ä¸‹æ–¹å±‚çº§**ä¸¥æ ¼ä¸€è‡´**ï¼Œå¦åˆ™ä¼šå¯¼è‡´åˆå§‹åŒ–å´©æºƒæˆ–å‘éŸ³å¼‚å¸¸ï¼š

```text
app/src/main/assets/
â”œâ”€â”€ asr/                      # æµå¼è¯†åˆ«æ¨¡å‹
â”‚   â”œâ”€â”€ encoder.int8.onnx     
â”‚   â”œâ”€â”€ decoder.int8.onnx
â”‚   â””â”€â”€ tokens.txt            
â”‚
â”œâ”€â”€ tts/                      # âš ï¸ æ­¤ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å¿…é¡»ç›´æ¥å¹³é“ºï¼Œä¸èƒ½æœ‰å­æ–‡ä»¶å¤¹
â”‚   â”œâ”€â”€ vits-bilingual.onnx   # æ³¨æ„ï¼šåŸå‹ç¼©åŒ…é‡Œçš„ model.onnx éœ€æ‰‹åŠ¨é‡å‘½åä¸ºæ­¤æ–‡ä»¶
â”‚   â”œâ”€â”€ tokens.txt
â”‚   â”œâ”€â”€ lexicon.txt
â”‚   â”œâ”€â”€ date.fst              # (åŸ dict æ–‡ä»¶å¤¹å†…æ–‡ä»¶)
â”‚   â”œâ”€â”€ number.fst            # (åŸ dict æ–‡ä»¶å¤¹å†…æ–‡ä»¶ï¼Œè´Ÿè´£æ•°å­—å‘éŸ³)
â”‚   â”œâ”€â”€ phone.fst             # (åŸ dict æ–‡ä»¶å¤¹å†…æ–‡ä»¶)
â”‚   â”œâ”€â”€ new_heteronym.fst     # (åŸ dict æ–‡ä»¶å¤¹å†…æ–‡ä»¶ï¼Œè´Ÿè´£å¤šéŸ³å­—)
â”‚   â””â”€â”€ jieba.dict.utf8       # (åŸ dict æ–‡ä»¶å¤¹å†…æ–‡ä»¶)
â”‚
â””â”€â”€ punct/                    # æ ‡ç‚¹æ’ç‰ˆæ¨¡å‹
    â””â”€â”€ model.onnx            

```

---

## ğŸ› ï¸ ç¯å¢ƒä¾èµ–

åœ¨æ‚¨çš„ `app/build.gradle` ä¸­å¼•å…¥ Sherpa-onnx çš„ AAR åº•å±‚åº“ï¼š

```groovy
dependencies {
    // å¼•å…¥æœ¬åœ° AAR æˆ–é€šè¿‡ Maven å¼•å…¥
    implementation files('libs/sherpa-onnx-1.12.23.aar') 
}

```

*éœ€åœ¨ `AndroidManifest.xml` ä¸­å£°æ˜éº¦å…‹é£æƒé™ `<uses-permission android:name="android.permission.RECORD_AUDIO" />*`

---

## ğŸš€ æ ¸å¿ƒæ¶æ„è®¾è®¡æ€è·¯

ä¸ºäº†çªç ´ç«¯ä¾§ç®—åŠ›é™åˆ¶ï¼Œæœ¬é¡¹ç›®åœ¨ `MainActivity.kt` ä¸­å®ç°äº†ä¸€å¥—æå…¶é«˜æ•ˆçš„æµæ°´çº¿æœºåˆ¶ï¼š

1. **TTS æ¶ˆè´¹è€…ç®¡é“ (`AudioTrack.MODE_STREAM`)**
   æˆ‘ä»¬æŠ›å¼ƒäº†ä¼ ç»Ÿçš„å…¨æ–‡ç”Ÿæˆå†æ’­æ”¾(`MODE_STATIC`)ï¼Œæ”¹ç”¨åº•å±‚ PCM ç®¡é“æ¨æµã€‚å³ä½¿æ˜¯ä¸€ç¯‡ 1000 å­—çš„æ–‡ç« ï¼Œåªè¦å‰ 10 ä¸ªå­—çš„å¼ é‡è¿ç®—å®Œæˆï¼Œç«‹åˆ»æ¨å…¥å£°å¡å‘å£°ï¼Œå®ç°äº†é›¶ç­‰å¾…ä½“éªŒã€‚
2. **å¤šé‡å®‰å…¨æŠ¤åŸæ²³**
* **è¾“å…¥çº§**ï¼šæ­£åˆ™è¡¨è¾¾å¼å¼ºåˆ¶è¿‡æ»¤ HTML æ ‡ç­¾ä¸è„å­—ç¬¦ï¼Œå¼ºåˆ¶è½¬å¤§å†™ï¼ˆé€‚é…ç¦»çº¿å­—å…¸ç‰¹æ€§é˜²åå­—ï¼‰ã€‚
* **å¤„ç†çº§**ï¼šæ™ºèƒ½åˆ†å¥é˜ˆå€¼åˆ¤å®šï¼ˆ`length > 25`ï¼‰ã€‚
* **è¾“å‡ºçº§**ï¼šç«¯ç‚¹å£°å­¦èƒ½é‡è¿‡æ»¤ (`threshold = 0.005f`)ï¼Œé¿å…å°†æ— å£°æ­»åŒºé€å…¥æ‰¬å£°å™¨ã€‚



## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº [Apache License 2.0](https://www.google.com/search?q=LICENSE) å¼€æºã€‚
åº•å±‚æ¨ç†å¼•æ“ç”±ä¼Ÿå¤§çš„ [Sherpa-onnx](https://github.com/k2-fsa/sherpa-onnx) ç¤¾åŒºæä¾›å¼ºåŠ›é©±åŠ¨ã€‚